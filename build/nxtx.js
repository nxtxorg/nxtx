!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):(e=e||self).nxtx=r()}(this,function(){"use strict";function e(e,r,t,n){return new(t||(t=Promise))(function(o,u){function a(e){try{c(n.next(e))}catch(e){u(e)}}function i(e){try{c(n.throw(e))}catch(e){u(e)}}function c(e){e.done?o(e.value):new t(function(r){r(e.value)}).then(a,i)}c((n=n.apply(e,r||[])).next())})}function r(e,r){var t,n,o,u,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return u={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function i(u){return function(i){return function(u){if(t)throw new TypeError("Generator is already executing.");for(;a;)try{if(t=1,n&&(o=2&u[0]?n.return:u[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,u[1])).done)return o;switch(n=0,o&&(u=[2&u[0],o.value]),u[0]){case 0:case 1:o=u;break;case 4:return a.label++,{value:u[1],done:!1};case 5:a.label++,n=u[1],u=[0];continue;case 7:u=a.ops.pop(),a.trys.pop();continue;default:if(!(o=(o=a.trys).length>0&&o[o.length-1])&&(6===u[0]||2===u[0])){a=0;continue}if(3===u[0]&&(!o||u[1]>o[0]&&u[1]<o[3])){a.label=u[1];break}if(6===u[0]&&a.label<o[1]){a.label=o[1],o=u;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(u);break}o[2]&&a.ops.pop(),a.trys.pop();continue}u=r.call(e,a)}catch(e){u=[6,e],n=0}finally{t=o=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,i])}}}var t=function(){function e(r,t,n,o){this.message=r,this.expected=t,this.found=n,this.location=o,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,e)}return function(e,r){function t(){this.constructor=e}t.prototype=r.prototype,e.prototype=new t}(e,Error),e.buildMessage=function(e,r){var t={literal:function(e){return'"'+o(e.text)+'"'},class:function(e){var r,t="";for(r=0;r<e.parts.length;r++)t+=e.parts[r]instanceof Array?u(e.parts[r][0])+"-"+u(e.parts[r][1]):u(e.parts[r]);return"["+(e.inverted?"^":"")+t+"]"},any:function(e){return"any character"},end:function(e){return"end of input"},other:function(e){return e.description}};function n(e){return e.charCodeAt(0).toString(16).toUpperCase()}function o(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(e){return"\\x0"+n(e)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(e){return"\\x"+n(e)})}function u(e){return e.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(e){return"\\x0"+n(e)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(e){return"\\x"+n(e)})}return"Expected "+function(e){var r,n,o,u=new Array(e.length);for(r=0;r<e.length;r++)u[r]=(o=e[r],t[o.type](o));if(u.sort(),u.length>0){for(r=1,n=1;r<u.length;r++)u[r-1]!==u[r]&&(u[n]=u[r],n++);u.length=n}switch(u.length){case 1:return u[0];case 2:return u[0]+" or "+u[1];default:return u.slice(0,-1).join(", ")+", or "+u[u.length-1]}}(e)+" but "+function(e){return e?'"'+o(e)+'"':"end of input"}(r)+" found."},{SyntaxError:e,parse:function(r,t){t=void 0!==t?t:{};var n,o={},u={Paragraphs:Xe},a=Xe,i=function(e,r){return[e,...r]},c=function(e){return[e]},s=function(e){return{type:ur.PARAGRAPH,value:e,location:Ue(Me,Se)}},l=Ye("paragraph"),f=Ye("text"),h=function(e){return{type:ur.TEXT,value:e.join("")}},p="\\\\",d=Le("\\\\",!1),v=function(){return"\\"},y=/^[^\r\n\\]/,m=Be(["\r","\n","\\"],!0,!1),g=function(){return Ge()},A=Ye("command"),b="\\",x=Le("\\",!1),C=function(e,r){return{type:ur.COMMAND,name:e,args:r||[]}},w=Ye("command name"),P=/^[_:\-]/,k=Be(["_",":","-"],!1,!1),E=/^[a-zA-Z!#-&*-+\--\/;-@]/,R=Be([["a","z"],["A","Z"],"!",["#","&"],["*","+"],["-","/"],[";","@"]],!1,!1),_=/^[0-9]/,j=Be([["0","9"]],!1,!1),T="(",O=Le("(",!1),N=")",S=Le(")",!1),M=function(e){return e},I=/^[^)]/,D=Be([")"],!0,!1),F=function(e){return[{type:ur.STRING,value:e.join("")}]},H=Ye("command arguments"),G=",",L=Le(",",!1),B=Ye("name"),Y=function(e){return{type:ur.STRING,value:e}},z=Ye("number"),U=".",q=Le(".",!1),X=function(e){return{type:ur.NUMBER,value:e?parseFloat(Ge()):parseInt(Ge(),10)}},Z=Ye("string"),J='"',K=Le('"',!1),Q=/^[^"]/,V=Be(['"'],!0,!1),W=function(e){return{type:ur.STRING,value:e.join("")}},$="'",ee=Le("'",!1),re=/^[^']/,te=Be(["'"],!0,!1),ne=Ye("array"),oe="[",ue=Le("[",!1),ae="]",ie=Le("]",!1),ce=function(e){return{type:ur.ARRAY,value:e}},se=function(){return{type:ur.ARRAY,value:[]}},le=Ye("dictionary"),fe="{",he=Le("{",!1),pe="}",de=Le("}",!1),ve=function(e){return{type:ur.DICTIONARY,value:e.reduce((e,r)=>(e[r.name]=r.value)&&e,{})}},ye=function(){return{type:ur.DICTIONARY,value:{}}},me=Ye("key-value pair(s)"),ge=Ye("key-value pair"),Ae=":",be=Le(":",!1),xe=function(e,r){return{name:e,value:r}},Ce=function(e,r){return{key:e.value,value:r}},we=Ye("newline"),Pe="\r\n",ke=Le("\r\n",!1),Ee="\r",Re=Le("\r",!1),_e="\n",je=Le("\n",!1),Te=Ye("optional inline whitespace"),Oe=/^[ \t]/,Ne=Be([" ","\t"],!1,!1),Se=0,Me=0,Ie=[{line:1,column:1}],De=0,Fe=[],He=0;if("startRule"in t){if(!(t.startRule in u))throw new Error("Can't start parsing from rule \""+t.startRule+'".');a=u[t.startRule]}function Ge(){return r.substring(Me,Se)}function Le(e,r){return{type:"literal",text:e,ignoreCase:r}}function Be(e,r,t){return{type:"class",parts:e,inverted:r,ignoreCase:t}}function Ye(e){return{type:"other",description:e}}function ze(e){var t,n=Ie[e];if(n)return n;for(t=e-1;!Ie[t];)t--;for(n={line:(n=Ie[t]).line,column:n.column};t<e;)10===r.charCodeAt(t)?(n.line++,n.column=1):n.column++,t++;return Ie[e]=n,n}function Ue(e,r){var t=ze(e),n=ze(r);return{start:{offset:e,line:t.line,column:t.column},end:{offset:r,line:n.line,column:n.column}}}function qe(e){Se<De||(Se>De&&(De=Se,Fe=[]),Fe.push(e))}function Xe(){var e,r,t,n,u,a;for(e=Se,r=[],t=nr();t!==o;)r.push(t),t=nr();if(r!==o)if((t=Ze())!==o)if((n=nr())!==o){if(u=[],(a=nr())!==o)for(;a!==o;)u.push(a),a=nr();else u=o;u!==o&&(a=Xe())!==o?(Me=e,e=r=i(t,a)):(Se=e,e=o)}else Se=e,e=o;else Se=e,e=o;else Se=e,e=o;if(e===o){for(e=Se,r=[],t=nr();t!==o;)r.push(t),t=nr();if(r!==o)if((t=Ze())!==o){for(n=[],u=nr();u!==o;)n.push(u),u=nr();n!==o?(Me=e,e=r=c(t)):(Se=e,e=o)}else Se=e,e=o;else Se=e,e=o}return e}function Ze(){var e,r;return e=Se,(r=function e(){var r,t,n,u;return He++,r=Se,(t=Je())!==o?((n=nr())===o&&(n=null),n!==o&&(u=e())!==o?(Me=r,t=i(t,u),r=t):(Se=r,r=o)):(Se=r,r=o),r===o&&(r=Se,(t=Je())!==o&&(Me=r,t=c(t)),r=t),He--,r===o&&(t=o,0===He&&qe(l)),r}())!==o&&(Me=e,r=s(r)),e=r}function Je(){var e;return(e=Qe())===o&&(e=function(){var e,r,t;if(He++,e=Se,r=[],(t=Ke())!==o)for(;t!==o;)r.push(t),t=Ke();else r=o;return r!==o&&(Me=e,r=h(r)),He--,(e=r)===o&&(r=o,0===He&&qe(f)),e}()),e}function Ke(){var e,t,n;if(He++,e=Se,r.substr(Se,2)===p?(t=p,Se+=2):(t=o,0===He&&qe(d)),t!==o&&(Me=e,t=v()),(e=t)===o){if(e=Se,t=[],y.test(r.charAt(Se))?(n=r.charAt(Se),Se++):(n=o,0===He&&qe(m)),n!==o)for(;n!==o;)t.push(n),y.test(r.charAt(Se))?(n=r.charAt(Se),Se++):(n=o,0===He&&qe(m));else t=o;t!==o&&(Me=e,t=g()),e=t}return He--,e===o&&(t=o,0===He&&qe(f)),e}function Qe(){var e,t,n,u;return He++,e=Se,92===r.charCodeAt(Se)?(t=b,Se++):(t=o,0===He&&qe(x)),t!==o&&(n=Ve())!==o?((u=function(){var e,t,n,u,a;if(e=Se,40===r.charCodeAt(Se)?(t=T,Se++):(t=o,0===He&&qe(O)),t!==o&&(n=or())!==o&&(u=$e())!==o&&or()!==o?(41===r.charCodeAt(Se)?(a=N,Se++):(a=o,0===He&&qe(S)),a!==o?(Me=e,t=M(u),e=t):(Se=e,e=o)):(Se=e,e=o),e===o)if(e=Se,40===r.charCodeAt(Se)?(t=T,Se++):(t=o,0===He&&qe(O)),t!==o){if(n=[],I.test(r.charAt(Se))?(u=r.charAt(Se),Se++):(u=o,0===He&&qe(D)),u!==o)for(;u!==o;)n.push(u),I.test(r.charAt(Se))?(u=r.charAt(Se),Se++):(u=o,0===He&&qe(D));else n=o;n!==o?(41===r.charCodeAt(Se)?(u=N,Se++):(u=o,0===He&&qe(S)),u!==o?(Me=e,t=F(n),e=t):(Se=e,e=o)):(Se=e,e=o)}else Se=e,e=o;return e}())===o&&(u=null),u!==o?(Me=e,e=t=C(n,u)):(Se=e,e=o)):(Se=e,e=o),He--,e===o&&(t=o,0===He&&qe(A)),e}function Ve(){var e,t,n;return He++,e=Se,(t=We())!==o&&(n=Ve())!==o?(Me=e,e=t=g()):(Se=e,e=o),e===o&&(e=Se,(t=We())!==o?(P.test(r.charAt(Se))?(n=r.charAt(Se),Se++):(n=o,0===He&&qe(k)),n!==o&&Ve()!==o?(Me=e,e=t=g()):(Se=e,e=o)):(Se=e,e=o),e===o&&(e=Se,(t=We())!==o&&(Me=e,t=g()),e=t)),He--,e===o&&(t=o,0===He&&qe(w)),e}function We(){var e,t,n;return e=Se,E.test(r.charAt(Se))?(t=r.charAt(Se),Se++):(t=o,0===He&&qe(R)),t!==o?(_.test(r.charAt(Se))?(n=r.charAt(Se),Se++):(n=o,0===He&&qe(j)),n===o&&(n=null),n!==o?e=t=[t,n]:(Se=e,e=o)):(Se=e,e=o),e}function $e(){var e,t,n,u,a;return He++,e=Se,(t=er())!==o&&or()!==o?(44===r.charCodeAt(Se)?(n=G,Se++):(n=o,0===He&&qe(L)),n!==o&&or()!==o?((u=nr())===o&&(u=null),u!==o&&or()!==o&&(a=$e())!==o?(Me=e,e=t=i(t,a)):(Se=e,e=o)):(Se=e,e=o)):(Se=e,e=o),e===o&&(e=Se,(t=er())!==o&&(Me=e,t=c(t)),e=t),He--,e===o&&(t=o,0===He&&qe(H)),e}function er(){var e;return(e=function(){var e,t,n,u,a,s;return He++,e=Se,123===r.charCodeAt(Se)?(t=fe,Se++):(t=o,0===He&&qe(he)),t!==o&&or()!==o?((n=nr())===o&&(n=null),n!==o&&or()!==o&&(u=function e(){var t,n,u,a;return He++,t=Se,(n=tr())!==o&&or()!==o&&(u=nr())!==o&&or()!==o&&(a=e())!==o?(Me=t,n=i(n,a),t=n):(Se=t,t=o),t===o&&(t=Se,(n=tr())!==o&&or()!==o?(44===r.charCodeAt(Se)?(u=G,Se++):(u=o,0===He&&qe(L)),u!==o&&or()!==o&&(a=e())!==o?(Me=t,n=i(n,a),t=n):(Se=t,t=o)):(Se=t,t=o),t===o&&(t=Se,(n=tr())!==o&&(Me=t,n=c(n)),t=n)),He--,t===o&&(n=o,0===He&&qe(me)),t}())!==o&&or()!==o?((a=nr())===o&&(a=null),a!==o&&or()!==o?(125===r.charCodeAt(Se)?(s=pe,Se++):(s=o,0===He&&qe(de)),s!==o?(Me=e,t=ve(u),e=t):(Se=e,e=o)):(Se=e,e=o)):(Se=e,e=o)):(Se=e,e=o),e===o&&(e=Se,123===r.charCodeAt(Se)?(t=fe,Se++):(t=o,0===He&&qe(he)),t!==o&&or()!==o?(125===r.charCodeAt(Se)?(n=pe,Se++):(n=o,0===He&&qe(de)),n!==o?(Me=e,t=ye(),e=t):(Se=e,e=o)):(Se=e,e=o)),He--,e===o&&(t=o,0===He&&qe(le)),e}())===o&&(e=function(){var e,t,n,u,a,i;return He++,e=Se,91===r.charCodeAt(Se)?(t=oe,Se++):(t=o,0===He&&qe(ue)),t!==o&&or()!==o?((n=nr())===o&&(n=null),n!==o&&or()!==o&&(u=$e())!==o&&or()!==o?((a=nr())===o&&(a=null),a!==o&&or()!==o?(93===r.charCodeAt(Se)?(i=ae,Se++):(i=o,0===He&&qe(ie)),i!==o?(Me=e,t=ce(u),e=t):(Se=e,e=o)):(Se=e,e=o)):(Se=e,e=o)):(Se=e,e=o),e===o&&(e=Se,91===r.charCodeAt(Se)?(t=oe,Se++):(t=o,0===He&&qe(ue)),t!==o&&or()!==o?(93===r.charCodeAt(Se)?(n=ae,Se++):(n=o,0===He&&qe(ie)),n!==o?(Me=e,t=se(),e=t):(Se=e,e=o)):(Se=e,e=o)),He--,e===o&&(t=o,0===He&&qe(ne)),e}())===o&&(e=Qe())===o&&(e=function(){var e,r;return He++,e=Se,(r=Ve())!==o&&(Me=e,r=Y(r)),He--,(e=r)===o&&(r=o,0===He&&qe(B)),e}())===o&&(e=function(){var e,t,n,u,a,i;if(He++,e=Se,t=[],_.test(r.charAt(Se))?(n=r.charAt(Se),Se++):(n=o,0===He&&qe(j)),n!==o)for(;n!==o;)t.push(n),_.test(r.charAt(Se))?(n=r.charAt(Se),Se++):(n=o,0===He&&qe(j));else t=o;if(t!==o){if(n=Se,46===r.charCodeAt(Se)?(u=U,Se++):(u=o,0===He&&qe(q)),u!==o){if(a=[],_.test(r.charAt(Se))?(i=r.charAt(Se),Se++):(i=o,0===He&&qe(j)),i!==o)for(;i!==o;)a.push(i),_.test(r.charAt(Se))?(i=r.charAt(Se),Se++):(i=o,0===He&&qe(j));else a=o;a!==o?n=u=[u,a]:(Se=n,n=o)}else Se=n,n=o;n===o&&(n=null),n!==o?(Me=e,t=X(n),e=t):(Se=e,e=o)}else Se=e,e=o;return He--,e===o&&(t=o,0===He&&qe(z)),e}())===o&&(e=rr()),e}function rr(){var e,t,n,u;if(He++,e=Se,34===r.charCodeAt(Se)?(t=J,Se++):(t=o,0===He&&qe(K)),t!==o){for(n=[],Q.test(r.charAt(Se))?(u=r.charAt(Se),Se++):(u=o,0===He&&qe(V));u!==o;)n.push(u),Q.test(r.charAt(Se))?(u=r.charAt(Se),Se++):(u=o,0===He&&qe(V));n!==o?(34===r.charCodeAt(Se)?(u=J,Se++):(u=o,0===He&&qe(K)),u!==o?(Me=e,e=t=W(n)):(Se=e,e=o)):(Se=e,e=o)}else Se=e,e=o;if(e===o)if(e=Se,39===r.charCodeAt(Se)?(t=$,Se++):(t=o,0===He&&qe(ee)),t!==o){for(n=[],re.test(r.charAt(Se))?(u=r.charAt(Se),Se++):(u=o,0===He&&qe(te));u!==o;)n.push(u),re.test(r.charAt(Se))?(u=r.charAt(Se),Se++):(u=o,0===He&&qe(te));n!==o?(39===r.charCodeAt(Se)?(u=$,Se++):(u=o,0===He&&qe(ee)),u!==o?(Me=e,e=t=W(n)):(Se=e,e=o)):(Se=e,e=o)}else Se=e,e=o;return He--,e===o&&(t=o,0===He&&qe(Z)),e}function tr(){var e,t,n,u;return He++,e=Se,(t=Ve())!==o&&or()!==o?(58===r.charCodeAt(Se)?(n=Ae,Se++):(n=o,0===He&&qe(be)),n!==o&&or()!==o&&(u=er())!==o?(Me=e,e=t=xe(t,u)):(Se=e,e=o)):(Se=e,e=o),e===o&&(e=Se,(t=rr())!==o&&or()!==o?(58===r.charCodeAt(Se)?(n=Ae,Se++):(n=o,0===He&&qe(be)),n!==o&&or()!==o&&(u=er())!==o?(Me=e,e=t=Ce(t,u)):(Se=e,e=o)):(Se=e,e=o)),He--,e===o&&(t=o,0===He&&qe(ge)),e}function nr(){var e;return He++,r.substr(Se,2)===Pe?(e=Pe,Se+=2):(e=o,0===He&&qe(ke)),e===o&&(13===r.charCodeAt(Se)?(e=Ee,Se++):(e=o,0===He&&qe(Re)),e===o&&(10===r.charCodeAt(Se)?(e=_e,Se++):(e=o,0===He&&qe(je)))),He--,e===o&&0===He&&qe(we),e}function or(){var e,t;for(He++,e=[],Oe.test(r.charAt(Se))?(t=r.charAt(Se),Se++):(t=o,0===He&&qe(Ne));t!==o;)e.push(t),Oe.test(r.charAt(Se))?(t=r.charAt(Se),Se++):(t=o,0===He&&qe(Ne));return He--,e===o&&(t=o,0===He&&qe(Te)),e}const ur={PARAGRAPH:1,COMMAND:2,TEXT:3,DICTIONARY:11,ARRAY:12,NUMBER:13,STRING:14};if((n=a())!==o&&Se===r.length)return n;throw n!==o&&Se<r.length&&qe({type:"end"}),function(r,t,n){return new e(e.buildMessage(r,t),r,t,n)}(Fe,De<r.length?r.charAt(De):null,De<r.length?Ue(De,De+1):Ue(De,De))}}}();function n(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function o(e,r){return e(r={exports:{}},r.exports),r.exports}var u=o(function(e,r){Object.defineProperty(r,"__esModule",{value:!0});var t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function n(e,r){function t(){var r=t.__proto__.apply(this,arguments);return Object.assign(r,e.apply(null,arguments)),r}return r=r||Error,Object.setPrototypeOf(t,r),t}r.SubError=n(function(e){return{name:"SubError",message:"SubError "+e.reduce(function(e,r){return e+="\n\n"+r.stack},""),errors:e}},Error),r.IterableError=n(function(e){return{name:"IterableError",message:"expecting an array or an iterable object but got "+(null===e?"null":void 0===e?"undefined":t(e))}},TypeError)});n(u);u.SubError,u.IterableError;var a=o(function(e,r){Object.defineProperty(r,"__esModule",{value:!0}),r.size=function(e){return Array.isArray(e)?e.length:Object.keys(e).length},r.repeat=function(e,r){for(var t=0;t<e;t++)r(t)},r.toArray=function(e){return Object.keys(e).map(function(r){return e[r]})},r.toBoolean=function(e){return!!e},r.identity=function(e){return e},r.defaults=function(e,r){var t=Object.assign({},r);return Object.keys(e).reduce(function(t,n){return t[n]=void 0===e[n]?r[n]:e[n],t},t)},r.isIterable=function(e){return e&&"function"==typeof e.entries},r.noop=function(){},r.isDefined=function(e){return void 0!==e}});n(a);a.size,a.repeat,a.toArray,a.toBoolean,a.identity,a.defaults,a.isIterable,a.noop,a.isDefined;var i=o(function(e,r){Object.defineProperty(r,"__esModule",{value:!0}),r.default=function(e){var r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return function(e){return Array.isArray(e)?Promise.all(e):Promise.resolve(e)}(e).then(function(e){return r&&!(0,a.isIterable)(e)?Promise.reject((0,u.IterableError)(e)):e})}});n(i);var c=n(o(function(e,r){Object.defineProperty(r,"__esModule",{value:!0}),r.default=function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:a.identity;return(0,n.default)(e).then(function(e){return Promise.all(e.map(r))})};var t,n=(t=i)&&t.__esModule?t:{default:t}})),s=o(function(e,r){Object.defineProperty(r,"__esModule",{value:!0}),r.default=function(e,r){return function(t){return t.reduce(function(r,n,o){return r.then(function(r){return e(r,n,o,t)})},Promise.resolve(r))}}});n(s);var l,f=n(o(function(e,r){Object.defineProperty(r,"__esModule",{value:!0}),r.default=function(e,r){return Promise.all(e).then((0,n.default)(function(e,t,n,o){return Promise.resolve(t).then(function(e){return r(e,n,o)}).then(function(r){return e.push(r),e})},[]))};var t,n=(t=s)&&t.__esModule?t:{default:t}})),h=n(o(function(e,r){Object.defineProperty(r,"__esModule",{value:!0}),r.default=function(e,r,o){return(0,n.default)(e).then((0,t.default)(r,o))};var t=o(s),n=o(i);function o(e){return e&&e.__esModule?e:{default:e}}}));!function(e){e[e.Paragraph=1]="Paragraph",e[e.Command=2]="Command",e[e.Text=3]="Text",e[e.Block=4]="Block",e[e.Html=5]="Html",e[e.Node=6]="Node",e[e.Dictionary=11]="Dictionary",e[e.Array=12]="Array",e[e.Number=13]="Number",e[e.String=14]="String"}(l||(l={}));var p=t,d=function(e,r,t,n){if(void 0===n&&(n=!1),!n&&void 0!==e[r])return console.warn("Command '"+r+"' is already registered. Set overwrite to true, if you need to overwrite the already registered command.");e[r]=t},v={".":!0,",":!0},y=function(e){var r=[],t=e.value.reduce(function(e,t){return t.type===l.Text?v[t.value[0]]?(e.push({type:l.Text,value:t.value[0]+" "}),1!==t.value.length&&r.push({type:l.Text,value:t.value.substr(1)})):r.push(t):(r.length&&(e.push({type:l.Text,value:r.map(function(e){return e.value}).join(" ")}),r.length=0),e.push(t)),e},[]);return r.length&&t.push({type:l.Text,value:r.map(function(e){return e.value}).join(" ")}),{type:e.type,value:t}},m=function(e){return!!e},g=function(t,n){return e(void 0,void 0,void 0,function(){return r(this,function(e){switch(e.label){case 0:return[4,c(t,n)];case 1:return[2,e.sent().flat()]}})})},A=function(t,n){return e(void 0,void 0,void 0,function(){return r(this,function(e){switch(e.label){case 0:return[4,c(t,n)];case 1:return[2,e.sent().flat().filter(m)]}})})},b=function(e){var r,t=!0;return e.reduce(function(e,n){return n.type===l.Paragraph?t=e.push.apply(e,b(n.value))&&!0:(t&&(t=e.push(r={type:l.Paragraph,value:[]})&&!1),r.value.push(n)),e},[]).flat()};return new(function(){function t(){var t=this;this.hooks={prerender:new Array,midrender:new Array,postrender:new Array},this.registeredPackages=new Array,this.commands={},this.preprocessors={},this.baseRenderNode=function(n){return e(t,void 0,void 0,function(){var e,t;return r(this,function(r){switch(r.label){case 0:if("string"==typeof n)return[2,this.text(n)];if(!n.type)return[2,n];switch(n.type){case l.Node:return[3,1];case l.Paragraph:return[3,2];case l.Html:return[3,4];case l.Text:return[3,5];case l.Command:return[3,6]}return[3,9];case 1:return[2,n];case 2:return[4,g(n.value,this.baseRenderNode)];case 3:return(e=r.sent()).length&&e.push(this.htmlLite("div",{class:"meta paragraph-break"})),[2,e];case 4:return[2,this.htmlLite("span",{innerHTML:n.value})];case 5:return[2,document.createTextNode(n.value)];case 6:return[4,this.executeCommand(n.name,n.args)];case 7:return t=[r.sent()].flat().filter(m),[4,g(t,this.baseRenderNode)];case 8:return[2,r.sent()];case 9:return console.error("Unrecognized node",n),[2]}})})},this.executeCommand=function(n,o){return e(t,void 0,void 0,function(){var e,t,u,a,i=this;return r(this,function(r){switch(r.label){case 0:return void 0===this.commands[n]?[3,3]:(t=(e=(a=this.commands)[n]).apply,u=[a],[4,c(o,function(e){return e.type===l.Command?i.executeCommand(e.name,e.args):e})]);case 1:return[4,t.apply(e,u.concat([r.sent()]))];case 2:return[2,r.sent()];case 3:return console.warn("Command '"+n+"' not registered"),[4,this.html("b",{class:"error"},n+"?")];case 4:return[2,r.sent()]}})})},this.executePreprocessor=function(n){return e(t,void 0,void 0,function(){var e,t,o,u;return r(this,function(r){switch(r.label){case 0:return n.type===l.Command&&this.preprocessors[n.name]?[4,(u=this.preprocessors)[n.name].apply(u,n.args)]:[3,3];case 1:return e=[r.sent()].flat().filter(m),[4,g(e,this.executePreprocessor)];case 2:return t=r.sent(),void 0===this.commands[n.name]?[2,t]:[3,5];case 3:return n.type!==l.Paragraph?[3,5]:(o=n,[4,A(n.value,this.executePreprocessor)]);case 4:o.value=r.sent(),r.label=5;case 5:return[2,n]}})})},this.executePreprocessors=function(n){return e(t,void 0,void 0,function(){var t=this;return r(this,function(o){switch(o.label){case 0:return[4,h(n,function(n,o){return e(t,void 0,void 0,function(){var e;return r(this,function(r){switch(r.label){case 0:return[4,A(o.value,this.executePreprocessor)];case 1:return e=r.sent(),n.push.apply(n,b(e)),[2,n]}})})},[])];case 1:return[2,o.sent()]}})})}}return t.trigger=function(e){return e.forEach(function(e){return e()})},t.prototype.registerCommand=function(e,r,t){return d(this.commands,e,r,t)},t.prototype.registerPreprocessor=function(e,r,t){return d(this.preprocessors,e,r,t)},t.prototype.verifyArguments=function(e){for(var r=[],t=1;t<arguments.length;t++)r[t-1]=arguments[t];var n=r.map(function(r,t){return{expected:e[t],actual:r.type,index:t}}).filter(function(e){return e.expected!==e.actual});return{ok:0===n.length,invalid:n}},t.prototype.parse=function(e){return p.parse(e).map(y)},t.prototype.registerPackage=function(e){var r=this;e.commands&&Object.keys(e.commands).forEach(function(t){return r.registerCommand(t,e.commands[t])}),e.preprocessors&&Object.keys(e.preprocessors).forEach(function(t){return r.registerPreprocessor(t,e.preprocessors[t])}),e.hooks&&(e.hooks.prerender&&this.on("prerender",e.hooks.prerender),e.hooks.postrender&&this.on("postrender",e.hooks.postrender)),e.requires&&e.requires.forEach(function(t){r.registeredPackages.includes(t)||console.warn("Package '"+e.name+"' requires '"+t+"' which has not been registered")}),this.registeredPackages.push(e.name)},t.prototype.render=function(n,o){return e(this,void 0,void 0,function(){var u,a,i,c,s,l,h=this;return r(this,function(p){switch(p.label){case 0:for(;o.firstChild;)o.removeChild(o.firstChild);return u=0,(i=function(){o.appendChild(a=h.htmlLite("section",{id:"page-"+ ++u,class:"sheet","data-page":u})),a.appendChild(h.htmlLite("div",{class:"meta page-start"}))})(),c=function(e){a.appendChild(e),a.scrollHeight>a.clientHeight&&(i(),a.appendChild(e))},t.trigger(this.hooks.prerender),s=this.parse(n).map(y),[4,this.executePreprocessors(s)];case 1:return l=p.sent(),t.trigger(this.hooks.midrender),[4,f(l,function(t){return e(h,void 0,void 0,function(){return r(this,function(e){switch(e.label){case 0:return[4,this.baseRenderNode(t)];case 1:return[2,e.sent()]}})})})];case 2:return p.sent().forEach(function(e){return e.forEach(c)}),t.trigger(this.hooks.postrender),[2]}})})},t.prototype.text=function(e){return document.createTextNode(e)},t.prototype.htmlLite=function(e,r){for(var t=this,n=[],o=2;o<arguments.length;o++)n[o-2]=arguments[o];var u=document.createElement(e);return Object.keys(r||{}).forEach(function(e){return u.setAttribute(e,r[e])}),n.forEach(function(e){return"string"==typeof e?u.appendChild(t.text(e)):u.appendChild(e)}),u},t.prototype.html=function(t,n){for(var o=[],u=2;u<arguments.length;u++)o[u-2]=arguments[u];return e(this,void 0,void 0,function(){var e,u,a,i;return r(this,function(r){switch(r.label){case 0:e=this.htmlLite(t,n),u=0,r.label=1;case 1:return u<o.length?(i=(a=e).appendChild,[4,this.baseRenderNode(o[u])]):[3,4];case 2:i.apply(a,[r.sent()]),r.label=3;case 3:return u++,[3,1];case 4:return[2,e]}})})},t.prototype.on=function(e,r){this.hooks[e].includes(r)||this.hooks[e].push(r)},t.prototype.off=function(e,r){var t=this.hooks[e].indexOf(r);-1!==t&&this.hooks[e].splice(t,1)},t}())});
//# sourceMappingURL=nxtx.js.map
