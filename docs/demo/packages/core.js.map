{"version":3,"file":"core.js","sources":["../../../src/packages/basic-formatting.js","../../../src/packages/layout.js","../../../src/packages/loading.js","../../../src/packages/styling.js","../../../src/packages/core.js"],"sourcesContent":["/*  Basic text formatting package for NxTx\r\n    Author: Malte Rosenbjerg\r\n    License: MIT */\r\nconst style = document.createElement(\"style\");\r\nstyle.id = 'basic-formatting-style-block';\r\ndocument.head.appendChild(style);\r\n\r\n// Default\r\nstyle.sheet.insertRule('.page-break { height: 0 }', 0);\r\nstyle.sheet.insertRule('.meta ~ .page-break:not(:last-child) { height: 100% }', 1);\r\nstyle.sheet.insertRule('.paragraph-break { height: 0 }', 2);\r\nstyle.sheet.insertRule('.meta ~ .paragraph-break:not(:last-child) { height: 1.2em }', 3);\r\n\r\nconst pkg = {\r\n    name: 'basic-formatting',\r\n    commands: {\r\n        'text:it': content => nxtx.html('i', null, content.value),\r\n        'text:bf': content => nxtx.html('b', null, content.value),\r\n        'text:tt': content => nxtx.html('code', null, content.value),\r\n        'dquote': contentNode => `“${contentNode.value}”`,\r\n        'break': () => nxtx.htmlLite('div', { class: 'meta', style: 'height: 1.5em' }),\r\n        'pagebreak': () => nxtx.htmlLite('div', { class: 'meta page-break' }),\r\n        'title': titleNode => (document.title = titleNode.value) && false\r\n    }\r\n};\r\n\r\nif (nxtx) {\r\n    Object.keys(pkg.commands).forEach(name => nxtx.registerCommand(name, pkg.commands[name]));\r\n}\r\n\r\nexport default pkg;","/*  Layout package for nxtx\r\n    Author: Thomas Gwynfryn McCollin\r\n    License: MIT */\r\n\r\nconst style = document.createElement(\"style\");\r\nstyle.id = 'layout-style-block';\r\ndocument.head.appendChild(style);\r\n\r\nconst parse = argNode => {\r\n    console.log(argNode);\r\n    if (argNode.type !== nxtx.TYPES.NUMBER) return argNode.value;\r\n    return argNode.value + 'mm';\r\n};\r\n\r\nconst replaceRule = (newRule, ruleIndex) => {\r\n    if (style.sheet.deleteRule) style.sheet.deleteRule(ruleIndex);\r\n    else if (style.sheet.removeRule) style.sheet.removeRule(ruleIndex);\r\n    style.sheet.insertRule(newRule, ruleIndex);\r\n};\r\n\r\nconst marginFormatters = {\r\n    all: value => { replaceRule(`.sheet { padding: ${value} }`, 1) },\r\n    left: value => { replaceRule(`.sheet { padding-left: ${value} }`, 1) },\r\n    top: value => { replaceRule(`.sheet { padding-top: ${value} }`, 1) },\r\n    right: value => { replaceRule(`.sheet { padding-right: ${value} }`, 1) },\r\n    bottom: value => { replaceRule(`.sheet { padding-bottom: ${value} }`, 1) },\r\n    vertical: value => { replaceRule(`.sheet { padding-top: ${value}; padding-bottom: ${value} }`, 1) },\r\n    horizontal: value => { replaceRule(`.sheet { padding-left: ${value}; padding-right: ${value} }`, 1) },\r\n\r\n    'head-separator': value => { style.sheet.insertRule(`header { margin-bottom: ${value}`, 2) },\r\n    'foot-skip': value => { style.sheet.insertRule(`footer { margin-top: ${value}`, 3) },\r\n};\r\n\r\n// Default\r\nstyle.sheet.insertRule('@page { size: A4 }', 0);\r\nstyle.sheet.insertRule(`.sheet { padding: 2cm }`, 1);\r\nstyle.sheet.insertRule('header { height: 3cm }', 2);\r\nstyle.sheet.insertRule('footer { height: 3cm }', 3);\r\n\r\nconst pkg = {\r\n    name: 'layout',\r\n    commands: {\r\n        'set-paper-size': paperSizeNode => replaceRule(`@page { size: ${paperSizeNode} }`, 0),\r\n        'set-header': heightNode => replaceRule(`header {height: ${heightNode}mm`, 2),\r\n        'set-footer': heightNode => replaceRule(`footer {height: ${heightNode}mm`, 3)\r\n    },\r\n    preprocessors: {\r\n        'set-margin': dictNode => Object.keys(dictNode.value).forEach(key => marginFormatters[key](parse(dictNode.value[key])))\r\n    }\r\n};\r\n\r\nif (nxtx) {\r\n    Object.keys(pkg.commands).forEach(name => nxtx.registerCommand(name, pkg.commands[name]));\r\n    Object.keys(pkg.preprocessors).forEach(name => nxtx.registerPreprocessor(name, pkg.preprocessors[name]));\r\n}\r\n\r\nexport default pkg;","/*  Package for loading documents and packages\r\n    Author: Malte Rosenbjerg\r\n    License: MIT */\r\n\r\nlet loaded = {\r\n    documents: {},\r\n    packages: []\r\n};\r\n\r\nconst pkg = {\r\n    name: 'loading',\r\n    preprocessors: {\r\n        'load:document': async nameNode => {\r\n            const name = nameNode.value.toString();\r\n            const filename = (name.substr(name.length - 5).toLowerCase() !== '.nxtx') ? `${name}.nxtx` : name;\r\n            const response = await fetch(filename);\r\n            if (!response.ok) return console.error(`NxTx document ${filename} not found`);\r\n\r\n            const lastModified = response.headers.get('last-modified');\r\n            const cached = loaded.documents[filename];\r\n            if (lastModified && cached && cached.lastModified === lastModified) {\r\n                console.log('using cached', filename);\r\n                return loaded.documents[filename].nodes;\r\n            }\r\n\r\n            const content = await response.text();\r\n            const nodes = nxtx.parse(content);\r\n            if (lastModified) {\r\n                loaded.documents[filename] = {lastModified, nodes};\r\n            }\r\n            return nodes;\r\n        },\r\n\r\n        'load:package': srcNode => new Promise((acc, rej) => {\r\n            if (loaded.packages[srcNode.value])\r\n                return acc();\r\n            loaded.packages[srcNode.value] = true;\r\n            const script = document.createElement('script');\r\n            script.src = srcNode.value;\r\n            script.async = true;\r\n            script.onreadystatechange = script.onload = () => {\r\n                if (!acc.done && (!script.readyState || /loaded|complete/.test(script.readyState))) {\r\n                    acc.done = true;\r\n                    acc();\r\n                }\r\n            };\r\n            document.head.appendChild(script);\r\n        })\r\n    }\r\n};\r\n\r\nif (nxtx) {\r\n    Object.keys(pkg.preprocessors).forEach(name => nxtx.registerPreprocessor(name, pkg.preprocessors[name]));\r\n}\r\n\r\nexport default pkg;","/*  Basic styling package package for nxtx\r\n    Author: Malte Rosenbjerg\r\n    License: MIT */\r\n\r\nconst style = document.createElement(\"style\");\r\nstyle.id = 'styling-style-block';\r\ndocument.head.appendChild(style);\r\n\r\n\r\n\r\nconst pkg = {\r\n    name: 'styling',\r\n    commands: {\r\n        'add-css-rule': (rule, index = 1) => style.sheet.insertRule(rule.value, index),\r\n        'set-root-style': (prop, ...values) => document.querySelector('.nxtx-root').style.setProperty(prop, values.map(e => e.value).join(', ')),\r\n        'set-font-family': (...fontFamilies) => ({\r\n            type: nxtx.TYPE.COMMAND,\r\n            name: 'set-root-style',\r\n            args: ['font-family', ...fontFamilies]\r\n        }),\r\n        'set-google-font-family': async (...fontFamilies) => {\r\n            const attr = {\r\n                rel: 'stylesheet',\r\n                href: `https://fonts.googleapis.com/css?family=${fontFamilies[0].value}&display=swap`,\r\n                id: 'link-gfont-' + fontFamilies[0].value\r\n            };\r\n            if (!document.getElementById(attr.id)) {\r\n                const link = await nxtx.html('link', attr);\r\n                document.head.appendChild(link);\r\n            }\r\n\r\n            return { type: nxtx.TYPE.COMMAND, name: 'set-font-family', args: fontFamilies };\r\n        }\r\n    }\r\n};\r\n\r\nif (nxtx) {\r\n    Object.keys(pkg.commands).forEach(name => nxtx.registerCommand(name, pkg.commands[name]));\r\n}\r\n\r\nexport default pkg;","import formatting from './basic-formatting';\r\nimport layout from './layout';\r\nimport loading from './loading';\r\nimport styling from './styling';\r\n\r\n\r\nexport default {\r\n    formatting,\r\n    layout,\r\n    loading,\r\n    styling\r\n}"],"names":["style","document","createElement","id","head","appendChild","sheet","insertRule","pkg","name","commands","text:it","content","nxtx","html","value","text:bf","text:tt","dquote","contentNode","break","htmlLite","class","pagebreak","title","titleNode","Object","keys","forEach","registerCommand","replaceRule","newRule","ruleIndex","deleteRule","removeRule","marginFormatters","all","left","top","right","bottom","vertical","horizontal","head-separator","foot-skip","set-paper-size","paperSizeNode","set-header","heightNode","set-footer","preprocessors","set-margin","dictNode","key","argNode","console","log","type","TYPES","NUMBER","parse","registerPreprocessor","loaded","documents","packages","load:document","async","nameNode","toString","filename","substr","length","toLowerCase","response","fetch","ok","error","lastModified","headers","get","cached","nodes","text","load:package","srcNode","Promise","acc","rej","script","src","onreadystatechange","onload","done","readyState","test","add-css-rule","rule","index","set-root-style","prop","values","querySelector","setProperty","map","e","join","set-font-family","fontFamilies","TYPE","COMMAND","args","set-google-font-family","attr","rel","href","getElementById","link","formatting","layout","loading","styling"],"mappings":"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"}