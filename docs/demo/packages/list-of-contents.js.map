{"version":3,"file":"list-of-contents.js","sources":["../../../src/packages/list-of-contents.js"],"sourcesContent":["/*  List of contents; Chapter, section etc. package for nxtx\r\n    Author: Malte Rosenbjerg\r\n    License: MIT */\r\n\r\nlet baseNumbering = {};\r\nlet numbering = {};\r\nlet parts = [];\r\nlet refs = {};\r\n\r\nconst style = document.createElement(\"style\");\r\nstyle.id = 'basic-formatting-style-block';\r\ndocument.head.appendChild(style);\r\n\r\nconst registerPart = (type, element) => {\r\n    baseNumbering[type] = 0;\r\n    numbering = { ...baseNumbering };\r\n    nxtx.registerPreprocessor(type, content => {\r\n        numbering[type] += 1;\r\n        resetChildrenNumbering(type);\r\n        parts.push({ type, title: content.value, numbering: { ...numbering } });\r\n    });\r\n    nxtx.registerCommand(type, content => nxtx.html(element, null, content.value));\r\n};\r\n\r\n[   // Ordering matters\r\n    ['chapter', 'h1'],\r\n    ['section', 'h3'],\r\n    ['subsection', 'h4'],\r\n].forEach(arr => registerPart(...arr));\r\n\r\nnxtx.registerPreprocessor('label', ref => {\r\n    if (refs[ref.value] !== undefined) console.warn(`Attempt to redefine label '${ref.value}' ignored`);\r\n    else refs[ref.value] = parts.length && parts[parts.length - 1];\r\n});\r\nnxtx.registerCommand('label', ref => {\r\n    return nxtx.html('span', {id: '--' + ref.value, 'data-label': ref.value});\r\n});\r\n\r\nconst resetChildrenNumbering = type => {\r\n    const types = Object.keys(numbering);\r\n    let reset = false;\r\n    for (let i = 0; i < types.length; i++) {\r\n        if (reset) numbering[types[i]] = 0;\r\n        else if (types[i] === type) reset = true;\r\n    }\r\n};\r\nconst capitalizeStr = str => str[0].toUpperCase() + str.substr(1);\r\nconst formatNumbering = numbering => Object.keys(numbering).map(k => numbering[k]).join('.').replace(/[.0]+$/, '');\r\nconst formatRef = (ref, capitalize) => {\r\n    const part = refs[ref];\r\n    if (!part) {\r\n        console.warn(`Label '${ref}' has not been referenced`);\r\n        return nxtx.html('b', { class: \"warning\" }, `${ref}`);\r\n    }\r\n    let result = '';\r\n    switch (part.type) {\r\n        case 'chapter':\r\n            result = `chapter ${formatNumbering(part.numbering)}`;\r\n            break;\r\n        case 'section':\r\n            result = `section ${formatNumbering(part.numbering)}`;\r\n            break;\r\n        case 'subsection':\r\n            result = `section ${formatNumbering(part.numbering)}`;\r\n            break;\r\n    }\r\n    return capitalize ? capitalizeStr(result) : result;\r\n};\r\nnxtx.registerCommand('ref', ref => {\r\n    return nxtx.html('a', {href: `#--${ref.value}`, 'data-ref': ref.value}, formatRef(ref.value, false));\r\n});\r\nnxtx.registerCommand('Ref', ref => {\r\n    return nxtx.html('a', {href: `#--${ref.value}`, 'data-ref': ref.value}, formatRef(ref.value, true));\r\n});\r\n\r\n\r\n\r\nnxtx.registerCommand('loc-print', () => {\r\n    return [\r\n        nxtx.html('h2', { class: 'list-of-contents' }, 'List of Contents'),\r\n        ...parts.map(part => nxtx.html('div', { class: `loc-${part.type}` }, `${formatNumbering(part.numbering)} ${part.title}`)),\r\n        { type: 'command', name: 'pagebreak', args: [] }\r\n    ];\r\n});\r\n\r\nnxtx.on('postrender', () => {\r\n    numbering = { ...baseNumbering };\r\n    parts = [];\r\n    refs = {};\r\n});\r\n\r\n// Default\r\nstyle.sheet.insertRule('.loc-chapter { font-size: 14pt }', 0);\r\nstyle.sheet.insertRule('.loc-section { font-size: 13pt; padding-left: 2em }', 1);\r\nstyle.sheet.insertRule('.loc-subsection { font-size: 12pt; padding-left: 4em }', 2);"],"names":[],"mappings":";;;IAAA;IACA;IACA;;IAEA,IAAI,aAAa,GAAG,EAAE,CAAC;IACvB,IAAI,SAAS,GAAG,EAAE,CAAC;IACnB,IAAI,KAAK,GAAG,EAAE,CAAC;IACf,IAAI,IAAI,GAAG,EAAE,CAAC;;IAEd,MAAM,KAAK,GAAG,QAAQ,CAAC,aAAa,CAAC,OAAO,CAAC,CAAC;IAC9C,KAAK,CAAC,EAAE,GAAG,8BAA8B,CAAC;IAC1C,QAAQ,CAAC,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC;;IAEjC,MAAM,YAAY,GAAG,CAAC,IAAI,EAAE,OAAO,KAAK;IACxC,IAAI,aAAa,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;IAC5B,IAAI,SAAS,GAAG,EAAE,GAAG,aAAa,EAAE,CAAC;IACrC,IAAI,IAAI,CAAC,oBAAoB,CAAC,IAAI,EAAE,OAAO,IAAI;IAC/C,QAAQ,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;IAC7B,QAAQ,sBAAsB,CAAC,IAAI,CAAC,CAAC;IACrC,QAAQ,KAAK,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,CAAC,KAAK,EAAE,SAAS,EAAE,EAAE,GAAG,SAAS,EAAE,EAAE,CAAC,CAAC;IAChF,KAAK,CAAC,CAAC;IACP,IAAI,IAAI,CAAC,eAAe,CAAC,IAAI,EAAE,OAAO,IAAI,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,IAAI,EAAE,OAAO,CAAC,KAAK,CAAC,CAAC,CAAC;IACnF,CAAC,CAAC;;IAEF;IACA,IAAI,CAAC,SAAS,EAAE,IAAI,CAAC;IACrB,IAAI,CAAC,SAAS,EAAE,IAAI,CAAC;IACrB,IAAI,CAAC,YAAY,EAAE,IAAI,CAAC;IACxB,CAAC,CAAC,OAAO,CAAC,GAAG,IAAI,YAAY,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC;;IAEvC,IAAI,CAAC,oBAAoB,CAAC,OAAO,EAAE,GAAG,IAAI;IAC1C,IAAI,IAAI,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,KAAK,SAAS,EAAE,OAAO,CAAC,IAAI,CAAC,CAAC,2BAA2B,EAAE,GAAG,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC,CAAC;IACxG,SAAS,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,GAAG,KAAK,CAAC,MAAM,IAAI,KAAK,CAAC,KAAK,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;IACnE,CAAC,CAAC,CAAC;IACH,IAAI,CAAC,eAAe,CAAC,OAAO,EAAE,GAAG,IAAI;IACrC,IAAI,OAAO,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE,IAAI,GAAG,GAAG,CAAC,KAAK,EAAE,YAAY,EAAE,GAAG,CAAC,KAAK,CAAC,CAAC,CAAC;IAC9E,CAAC,CAAC,CAAC;;IAEH,MAAM,sBAAsB,GAAG,IAAI,IAAI;IACvC,IAAI,MAAM,KAAK,GAAG,MAAM,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;IACzC,IAAI,IAAI,KAAK,GAAG,KAAK,CAAC;IACtB,IAAI,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,KAAK,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;IAC3C,QAAQ,IAAI,KAAK,EAAE,SAAS,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC;IAC3C,aAAa,IAAI,KAAK,CAAC,CAAC,CAAC,KAAK,IAAI,EAAE,KAAK,GAAG,IAAI,CAAC;IACjD,KAAK;IACL,CAAC,CAAC;IACF,MAAM,aAAa,GAAG,GAAG,IAAI,GAAG,CAAC,CAAC,CAAC,CAAC,WAAW,EAAE,GAAG,GAAG,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;IAClE,MAAM,eAAe,GAAG,SAAS,IAAI,MAAM,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC,GAAG,CAAC,CAAC,IAAI,SAAS,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,OAAO,CAAC,QAAQ,EAAE,EAAE,CAAC,CAAC;IACnH,MAAM,SAAS,GAAG,CAAC,GAAG,EAAE,UAAU,KAAK;IACvC,IAAI,MAAM,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC;IAC3B,IAAI,IAAI,CAAC,IAAI,EAAE;IACf,QAAQ,OAAO,CAAC,IAAI,CAAC,CAAC,OAAO,EAAE,GAAG,CAAC,yBAAyB,CAAC,CAAC,CAAC;IAC/D,QAAQ,OAAO,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE,EAAE,KAAK,EAAE,SAAS,EAAE,EAAE,CAAC,EAAE,GAAG,CAAC,CAAC,CAAC,CAAC;IAC9D,KAAK;IACL,IAAI,IAAI,MAAM,GAAG,EAAE,CAAC;IACpB,IAAI,QAAQ,IAAI,CAAC,IAAI;IACrB,QAAQ,KAAK,SAAS;IACtB,YAAY,MAAM,GAAG,CAAC,QAAQ,EAAE,eAAe,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC;IAClE,YAAY,MAAM;IAClB,QAAQ,KAAK,SAAS;IACtB,YAAY,MAAM,GAAG,CAAC,QAAQ,EAAE,eAAe,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC;IAClE,YAAY,MAAM;IAClB,QAAQ,KAAK,YAAY;IACzB,YAAY,MAAM,GAAG,CAAC,QAAQ,EAAE,eAAe,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC;IAClE,YAAY,MAAM;IAClB,KAAK;IACL,IAAI,OAAO,UAAU,GAAG,aAAa,CAAC,MAAM,CAAC,GAAG,MAAM,CAAC;IACvD,CAAC,CAAC;IACF,IAAI,CAAC,eAAe,CAAC,KAAK,EAAE,GAAG,IAAI;IACnC,IAAI,OAAO,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE,CAAC,IAAI,EAAE,CAAC,GAAG,EAAE,GAAG,CAAC,KAAK,CAAC,CAAC,EAAE,UAAU,EAAE,GAAG,CAAC,KAAK,CAAC,EAAE,SAAS,CAAC,GAAG,CAAC,KAAK,EAAE,KAAK,CAAC,CAAC,CAAC;IACzG,CAAC,CAAC,CAAC;IACH,IAAI,CAAC,eAAe,CAAC,KAAK,EAAE,GAAG,IAAI;IACnC,IAAI,OAAO,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE,CAAC,IAAI,EAAE,CAAC,GAAG,EAAE,GAAG,CAAC,KAAK,CAAC,CAAC,EAAE,UAAU,EAAE,GAAG,CAAC,KAAK,CAAC,EAAE,SAAS,CAAC,GAAG,CAAC,KAAK,EAAE,IAAI,CAAC,CAAC,CAAC;IACxG,CAAC,CAAC,CAAC;;;;IAIH,IAAI,CAAC,eAAe,CAAC,WAAW,EAAE,MAAM;IACxC,IAAI,OAAO;IACX,QAAQ,IAAI,CAAC,IAAI,CAAC,IAAI,EAAE,EAAE,KAAK,EAAE,kBAAkB,EAAE,EAAE,kBAAkB,CAAC;IAC1E,QAAQ,GAAG,KAAK,CAAC,GAAG,CAAC,IAAI,IAAI,IAAI,CAAC,IAAI,CAAC,KAAK,EAAE,EAAE,KAAK,EAAE,CAAC,IAAI,EAAE,IAAI,CAAC,IAAI,CAAC,CAAC,EAAE,EAAE,CAAC,EAAE,eAAe,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,EAAE,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;IACjI,QAAQ,EAAE,IAAI,EAAE,SAAS,EAAE,IAAI,EAAE,WAAW,EAAE,IAAI,EAAE,EAAE,EAAE;IACxD,KAAK,CAAC;IACN,CAAC,CAAC,CAAC;;IAEH,IAAI,CAAC,EAAE,CAAC,YAAY,EAAE,MAAM;IAC5B,IAAI,SAAS,GAAG,EAAE,GAAG,aAAa,EAAE,CAAC;IACrC,IAAI,KAAK,GAAG,EAAE,CAAC;IACf,IAAI,IAAI,GAAG,EAAE,CAAC;IACd,CAAC,CAAC,CAAC;;IAEH;IACA,KAAK,CAAC,KAAK,CAAC,UAAU,CAAC,kCAAkC,EAAE,CAAC,CAAC,CAAC;IAC9D,KAAK,CAAC,KAAK,CAAC,UAAU,CAAC,qDAAqD,EAAE,CAAC,CAAC,CAAC;IACjF,KAAK,CAAC,KAAK,CAAC,UAAU,CAAC,wDAAwD,EAAE,CAAC,CAAC;;;;"}