{"version":3,"file":"list-of-contents.js","sources":["../../../src/packages/list-of-contents.js"],"sourcesContent":["/*  List of contents; Chapter, section etc. package for nxtx\r\n    Author: Malte Rosenbjerg\r\n    License: MIT */\r\n\r\nlet baseNumbering = {};\r\nlet numbering = {};\r\nlet parts = [];\r\nlet refs = {};\r\n\r\nconst style = document.createElement(\"style\");\r\nstyle.id = 'basic-formatting-style-block';\r\ndocument.head.appendChild(style);\r\n\r\nconst registerPart = (type, element) => {\r\n    baseNumbering[type] = 0;\r\n    numbering = { ...baseNumbering };\r\n    nxtx.registerPreprocessor(type, content => {\r\n        numbering[type] += 1;\r\n        resetChildrenNumbering(type);\r\n        parts.push({ type, title: content.value, numbering: { ...numbering } });\r\n    });\r\n    nxtx.registerCommand(type, content => nxtx.html(element, null, content.value));\r\n};\r\n\r\n[   // Ordering matters\r\n    ['chapter', 'h1'],\r\n    ['section', 'h3'],\r\n    ['subsection', 'h4'],\r\n].forEach(arr => registerPart(...arr));\r\n\r\nnxtx.registerPreprocessor('label', ref => {\r\n    console.log('label');\r\n    if (refs[ref.value] !== undefined) console.warn(`Attempt to redefine label '${ref.value}' ignored`);\r\n    else refs[ref.value] = parts.length && parts[parts.length - 1];\r\n});\r\nnxtx.registerCommand('label', ref => {\r\n    return nxtx.html('span', {id: '--' + ref.value, 'data-label': ref.value});\r\n});\r\n\r\nconst resetChildrenNumbering = type => {\r\n    const types = Object.keys(numbering);\r\n    let reset = false;\r\n    for (let i = 0; i < types.length; i++) {\r\n        if (reset) numbering[types[i]] = 0;\r\n        else if (types[i] === type) reset = true;\r\n    }\r\n};\r\nconst capitalizeStr = str => str[0].toUpperCase() + str.substr(1);\r\nconst formatNumbering = numbering => Object.keys(numbering).map(k => numbering[k]).join('.').replace(/[.0]+$/, '');\r\nconst formatRef = (ref, capitalize) => {\r\n    const part = refs[ref];\r\n    if (!part) {\r\n        console.warn(`Label '${ref}' has not been referenced`);\r\n        return nxtx.html('b', { class: \"warning\" }, `${ref}`);\r\n    }\r\n    let result = '';\r\n    switch (part.type) {\r\n        case 'chapter':\r\n            result = `chapter ${formatNumbering(part.numbering)}`;\r\n            break;\r\n        case 'section':\r\n            result = `section ${formatNumbering(part.numbering)}`;\r\n            break;\r\n        case 'subsection':\r\n            result = `section ${formatNumbering(part.numbering)}`;\r\n            break;\r\n    }\r\n    return capitalize ? capitalizeStr(result) : result;\r\n};\r\nnxtx.registerCommand('ref', ref => {\r\n    return nxtx.html('a', {href: `#--${ref.value}`, 'data-ref': ref.value}, formatRef(ref.value, false));\r\n});\r\nnxtx.registerCommand('Ref', ref => {\r\n    return nxtx.html('a', {href: `#--${ref.value}`, 'data-ref': ref.value}, formatRef(ref.value, true));\r\n});\r\n\r\n\r\n\r\nnxtx.registerCommand('loc-print', () => {\r\n    const rendition = [\r\n        nxtx.html('h2', { class: 'list-of-contents' }, 'List of Contents'),\r\n        ...parts.map(part => nxtx.html('div', { class: `loc-${part.type}` }, `${formatNumbering(part.numbering)} ${part.title}`)),\r\n        { type: nxtx.TYPE.COMMAND, name: 'pagebreak', args: [] }\r\n    ];\r\n    return rendition;\r\n});\r\n\r\nnxtx.on('postrender', () => {\r\n    numbering = { ...baseNumbering };\r\n    parts = [];\r\n    refs = {};\r\n});\r\n\r\n// Default\r\nstyle.sheet.insertRule('.loc-chapter { font-size: 14pt }', 0);\r\nstyle.sheet.insertRule('.loc-section { font-size: 13pt; padding-left: 2em }', 1);\r\nstyle.sheet.insertRule('.loc-subsection { font-size: 12pt; padding-left: 4em }', 2);"],"names":["baseNumbering","numbering","parts","refs","style","document","createElement","id","head","appendChild","forEach","arr","type","element","nxtx","registerPreprocessor","content","resetChildrenNumbering","push","title","value","registerCommand","html","registerPart","ref","console","log","undefined","warn","length","data-label","types","Object","keys","reset","i","formatNumbering","map","k","join","replace","formatRef","capitalize","part","class","result","str","toUpperCase","substr","capitalizeStr","href","data-ref","TYPE","COMMAND","name","args","on","sheet","insertRule"],"mappings":"yBAIA,IAAIA,EAAgB,GAChBC,EAAY,GACZC,EAAQ,GACRC,EAAO,GAEX,MAAMC,EAAQC,SAASC,cAAc,SACrCF,EAAMG,GAAK,+BACXF,SAASG,KAAKC,YAAYL,GAa1B,CACI,CAAC,UAAW,MACZ,CAAC,UAAW,MACZ,CAAC,aAAc,OACjBM,QAAQC,GAfW,EAACC,EAAMC,KACxBb,EAAcY,GAAQ,EACtBX,EAAY,IAAKD,GACjBc,KAAKC,qBAAqBH,EAAMI,IAC5Bf,EAAUW,IAAS,EACnBK,EAAuBL,GACvBV,EAAMgB,KAAK,CAAEN,KAAAA,EAAMO,MAAOH,EAAQI,MAAOnB,UAAW,IAAKA,OAE7Da,KAAKO,gBAAgBT,EAAMI,GAAWF,KAAKQ,KAAKT,EAAS,KAAMG,EAAQI,SAO1DG,IAAgBZ,IAEjCG,KAAKC,qBAAqB,QAASS,IAC/BC,QAAQC,IAAI,cACYC,IAApBxB,EAAKqB,EAAIJ,OAAsBK,QAAQG,mCAAmCJ,EAAIJ,kBAC7EjB,EAAKqB,EAAIJ,OAASlB,EAAM2B,QAAU3B,EAAMA,EAAM2B,OAAS,KAEhEf,KAAKO,gBAAgB,QAASG,GACnBV,KAAKQ,KAAK,OAAQ,CAACf,GAAI,KAAOiB,EAAIJ,MAAOU,aAAcN,EAAIJ,SAGtE,MAAMH,EAAyBL,IAC3B,MAAMmB,EAAQC,OAAOC,KAAKhC,GAC1B,IAAIiC,GAAQ,EACZ,IAAK,IAAIC,EAAI,EAAGA,EAAIJ,EAAMF,OAAQM,IAC1BD,EAAOjC,EAAU8B,EAAMI,IAAM,EACxBJ,EAAMI,KAAOvB,IAAMsB,GAAQ,IAItCE,EAAkBnC,GAAa+B,OAAOC,KAAKhC,GAAWoC,IAAIC,GAAKrC,EAAUqC,IAAIC,KAAK,KAAKC,QAAQ,SAAU,IACzGC,EAAY,CAACjB,EAAKkB,KACpB,MAAMC,EAAOxC,EAAKqB,GAClB,IAAKmB,EAED,OADAlB,QAAQG,eAAeJ,8BAChBV,KAAKQ,KAAK,IAAK,CAAEsB,MAAO,cAAgBpB,KAEnD,IAAIqB,EAAS,GACb,OAAQF,EAAK/B,MACT,IAAK,UACDiC,aAAoBT,EAAgBO,EAAK1C,aACzC,MACJ,IAAK,UAGL,IAAK,aACD4C,aAAoBT,EAAgBO,EAAK1C,aAGjD,OAAOyC,EApBWI,CAAAA,GAAOA,EAAI,GAAGC,cAAgBD,EAAIE,OAAO,GAoBvCC,CAAcJ,GAAUA,GAEhD/B,KAAKO,gBAAgB,MAAOG,GACjBV,KAAKQ,KAAK,IAAK,CAAC4B,WAAY1B,EAAIJ,QAAS+B,WAAY3B,EAAIJ,OAAQqB,EAAUjB,EAAIJ,OAAO,KAEjGN,KAAKO,gBAAgB,MAAOG,GACjBV,KAAKQ,KAAK,IAAK,CAAC4B,WAAY1B,EAAIJ,QAAS+B,WAAY3B,EAAIJ,OAAQqB,EAAUjB,EAAIJ,OAAO,KAKjGN,KAAKO,gBAAgB,YAAa,KAM9B,MALkB,CACdP,KAAKQ,KAAK,KAAM,CAAEsB,MAAO,oBAAsB,uBAC5C1C,EAAMmC,IAAIM,GAAQ7B,KAAKQ,KAAK,MAAO,CAAEsB,aAAcD,EAAK/B,WAAawB,EAAgBO,EAAK1C,cAAc0C,EAAKxB,UAChH,CAAEP,KAAME,KAAKsC,KAAKC,QAASC,KAAM,YAAaC,KAAM,OAK5DzC,KAAK0C,GAAG,aAAc,KAClBvD,EAAY,IAAKD,GACjBE,EAAQ,GACRC,EAAO,KAIXC,EAAMqD,MAAMC,WAAW,mCAAoC,GAC3DtD,EAAMqD,MAAMC,WAAW,sDAAuD,GAC9EtD,EAAMqD,MAAMC,WAAW,yDAA0D"}