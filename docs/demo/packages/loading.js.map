{"version":3,"file":"loading.js","sources":["../../../src/packages/loading.js"],"sourcesContent":["/*  Package for loading documents and packages\r\n    Author: Malte Rosenbjerg\r\n    License: MIT */\r\n\r\nlet loaded = {\r\n    documents: {},\r\n    packages: []\r\n};\r\n\r\nconst pkg = {\r\n    name: 'loading',\r\n    commands: {\r\n        'load:document': async nameNode => {\r\n            const name = nameNode.value.toString();\r\n            const filename = (name.substr(name.length - 5).toLowerCase() !== '.nxtx') ? `${name}.nxtx` : name;\r\n            const response = await fetch(filename);\r\n            if (!response.ok) return console.error(`NxTx document ${filename} not found`);\r\n\r\n            const lastModified = response.headers.get('last-modified');\r\n            const cached = loaded.documents[filename];\r\n            if (lastModified && cached && cached.lastModified === lastModified) {\r\n                console.log('using cached', filename);\r\n                return loaded.documents[filename].nodes;\r\n            }\r\n\r\n            const content = await response.text();\r\n            const nodes = nxtx.parse(content);\r\n            if (lastModified) {\r\n                loaded.documents[filename] = {lastModified, nodes};\r\n            }\r\n            return nodes;\r\n        }\r\n    },\r\n    preprocessors: {\r\n        'load:package': srcNode => new Promise((acc, rej) => {\r\n            if (loaded.packages[srcNode.value])\r\n                return acc();\r\n            loaded.packages[srcNode.value] = true;\r\n            const script = document.createElement('script');\r\n            script.src = srcNode.value;\r\n            script.async = true;\r\n            script.onreadystatechange = script.onload = () => {\r\n                if (!acc.done && (!script.readyState || /loaded|complete/.test(script.readyState))) {\r\n                    acc.done = true;\r\n                    acc();\r\n                }\r\n            };\r\n            document.head.appendChild(script);\r\n        })\r\n    }\r\n};\r\n\r\nif (nxtx) {\r\n    Object.keys(pkg.commands).forEach(name => nxtx.registerCommand(name, pkg.commands[name]));\r\n    Object.keys(pkg.preprocessors).forEach(name => nxtx.registerPreprocessor(name, pkg.preprocessors[name]));\r\n}\r\n\r\nexport default pkg;"],"names":[],"mappings":"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"}